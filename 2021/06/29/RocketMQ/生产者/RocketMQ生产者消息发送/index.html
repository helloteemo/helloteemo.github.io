<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="https://img.helloteemo.com.cn/favicon-32x32-next.ico"><link rel="icon" type="image/png" sizes="16x16" href="https://img.helloteemo.com.cn/favicon-16x16-next.ico"><link rel="mask-icon" href="/images/logo.svg" color="#222"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="google-site-verification" content="cRV2yI-DzG-36rSY_KkaZUfbhwP44Pcb00CdmjipHYU"><meta name="baidu-site-verification" content="code-nKoW4lrjrO"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:"helloteemo.github.io",root:"/",scheme:"Pisces",version:"7.8.0",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!0,show_result:!0,style:"flat"},back2top:{enable:!0,sidebar:!0,scrollpercent:!0},bookmark:{enable:!0,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},path:"search.xml"}</script><meta name="description" content="还是书接上文 [RocketMQ生产者] ，我们把目光投入到消息发送中，由于篇幅限制，本文章我们只介绍同步发送，中间可能会穿插一些其余的内容。"><meta property="og:type" content="article"><meta property="og:title" content="RocketMQ 生产者消息发送"><meta property="og:url" content="https://helloteemo.github.io/2021/06/29/RocketMQ/%E7%94%9F%E4%BA%A7%E8%80%85/RocketMQ%E7%94%9F%E4%BA%A7%E8%80%85%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81/index.html"><meta property="og:site_name" content="芒果zzZ"><meta property="og:description" content="还是书接上文 [RocketMQ生产者] ，我们把目光投入到消息发送中，由于篇幅限制，本文章我们只介绍同步发送，中间可能会穿插一些其余的内容。"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2021-06-29T06:12:23.000Z"><meta property="article:modified_time" content="2025-02-10T10:26:42.008Z"><meta property="article:author" content="芒果zzZ"><meta property="article:tag" content="RocketMQ"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://helloteemo.github.io/2021/06/29/RocketMQ/%E7%94%9F%E4%BA%A7%E8%80%85/RocketMQ%E7%94%9F%E4%BA%A7%E8%80%85%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0,lang:"zh-CN"}</script><title>RocketMQ 生产者消息发送 | 芒果zzZ</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css"><link rel="alternate" href="/atom.xml" title="芒果zzZ" type="application/atom+xml">
</head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span><h1 class="site-title">芒果zzZ</h1><span class="logo-line-after"><i></i></span></a><p class="site-subtitle" itemprop="description">Java Go</p></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a></li><li class="menu-item menu-item-schedule"><a href="/schedule/" rel="section"><i class="fa fa-fw fa-calendar"></i>日程表</a></li><li class="menu-item menu-item-todolist"><a href="/todolist/" rel="section"><i class="fa fa-fw fa-clipboard"></i>todolist</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="fa fa-fw fa-sitemap"></i>站点地图</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"><div id="no-result"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div></div></div></div></header><div class="reading-progress-bar"></div><a role="button" class="book-mark-link book-mark-link-fixed"></a><main class="main"><div class="main-inner"><div class="content-wrap" style="margin-top:2%"><div class="content post posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://helloteemo.github.io/2021/06/29/RocketMQ/%E7%94%9F%E4%BA%A7%E8%80%85/RocketMQ%E7%94%9F%E4%BA%A7%E8%80%85%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="https://img.helloteemo.com.cn/logo.png"><meta itemprop="name" content="芒果zzZ"><meta itemprop="description" content="纵有风花雪月又如何"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="芒果zzZ"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">RocketMQ 生产者消息发送</h1><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2021-06-29 14:12:23" itemprop="dateCreated datePublished" datetime="2021-06-29T14:12:23+08:00">2021-06-29</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2025-02-10 18:26:42" itemprop="dateModified" datetime="2025-02-10T18:26:42+08:00">2025-02-10</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/RocketMQ/" itemprop="url" rel="index"><span itemprop="name">RocketMQ</span></a> </span>， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/RocketMQ/%E7%94%9F%E4%BA%A7%E8%80%85/" itemprop="url" rel="index"><span itemprop="name">生产者</span></a> </span></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="post-meta-item-text">阅读次数：</span> <span id="busuanzi_value_page_pv"></span></span><br><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>8.8k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>8 分钟</span></span></div></header><div class="post-body" itemprop="articleBody"><blockquote><p>还是书接上文 <a href="/2021/06/25/RocketMQ/%E7%94%9F%E4%BA%A7%E8%80%85/RocketMQ%E7%94%9F%E4%BA%A7%E8%80%85/" title="[RocketMQ生产者]">[RocketMQ生产者]</a> ，我们把目光投入到消息发送中，由于篇幅限制，本文章我们只介绍同步发送，中间可能会穿插一些其余的内容。</p></blockquote><span id="more"></span><h1 id="rocketmq-生产者消息发送">RocketMQ 生产者消息发送</h1><p>我们一般在使用RocketMQ客户端的时候一般把它分为三层：业务层、消息处理层、通信层，其中业务层一般为调用 <code>producer.send(message)</code> 的那一层，消息处理层主要接受业务层传递过来的消息体，做一些处理：检查消息是否合规、压缩消息等，并为通信层做准备。通信层是指Rocket MQ基于Netty封装的一个RPC通信服务。</p><p>消息发送流程的主要步骤为：验证消息、查找路由、发送消息(包括异常处理等)，接下来我们会一一讲解这三个步骤。</p><h2 id="验证消息">验证消息</h2><pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">SendResult</span> <span class="token function">send</span><span class="token punctuation">(</span>
    <span class="token class-name">Message</span> msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">MQClientException</span><span class="token punctuation">,</span> <span class="token class-name">RemotingException</span><span class="token punctuation">,</span> <span class="token class-name">MQBrokerException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Validators</span><span class="token punctuation">.</span><span class="token function">checkMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    msg<span class="token punctuation">.</span><span class="token function">setTopic</span><span class="token punctuation">(</span><span class="token function">withNamespace</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQProducerImpl<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre><p>这一部分主要体现在 <code>DefaultMQProducer</code> 的 <code>Validators.checkMessage(msg, this);</code> 步骤中，其中主要包含了验证消息是否为空、检查topic是否合规、检查消息体是否为空是否大于最大长度(默认为4M)。同时为了支持 <code>namespace</code> 重新设置一下消息的 <code>topic</code> 信息。</p><p>之后又是我们的老朋友 <code>DefaultMQProducerImpl</code> ,上一篇文章中我们讲到了 <code>DefaultMQProducerImpl</code> 是生产者的默认实现，可以认为它负责生产者的所有消息发送操作。</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">int</span> sendMsgTimeout <span class="token operator">=</span> <span class="token number">3000</span><span class="token punctuation">;</span>
<span class="token comment">/**
* DEFAULT SYNC -------------------------------------------------------
*/</span>
<span class="token keyword">public</span> <span class="token class-name">SendResult</span> <span class="token function">send</span><span class="token punctuation">(</span>
    <span class="token class-name">Message</span> msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">MQClientException</span><span class="token punctuation">,</span> <span class="token class-name">RemotingException</span><span class="token punctuation">,</span> <span class="token class-name">MQBrokerException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">send</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQProducer<span class="token punctuation">.</span><span class="token function">getSendMsgTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token class-name">SendResult</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">Message</span> msg<span class="token punctuation">,</span>
        <span class="token keyword">long</span> timeout<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">MQClientException</span><span class="token punctuation">,</span> <span class="token class-name">RemotingException</span><span class="token punctuation">,</span> <span class="token class-name">MQBrokerException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">sendDefaultImpl</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token class-name">CommunicationMode</span><span class="token punctuation">.</span>SYNC<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">private</span> <span class="token class-name">SendResult</span> <span class="token function">sendDefaultImpl</span><span class="token punctuation">(</span>
        <span class="token class-name">Message</span> msg<span class="token punctuation">,</span>
        <span class="token keyword">final</span> <span class="token class-name">CommunicationMode</span> communicationMode<span class="token punctuation">,</span>
        <span class="token keyword">final</span> <span class="token class-name">SendCallback</span> sendCallback<span class="token punctuation">,</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> timeout
    <span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">MQClientException</span><span class="token punctuation">,</span> <span class="token class-name">RemotingException</span><span class="token punctuation">,</span> <span class="token class-name">MQBrokerException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">makeSureStateOK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Validators</span><span class="token punctuation">.</span><span class="token function">checkMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQProducer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// do send</span>
<span class="token punctuation">&#125;</span></code></pre><p>从上面这几段代码可以知道：消息默认以同步的方式发送，默认超时时间为3S，同时检查一下当前生产者是否处于可用状态。</p><blockquote><p>Q：为什么 <code>DefaultMQProducer</code> 验证了一遍消息，<code>DefaultMQProducerImpl</code> 还需要再次验证！！！</p><p>A：实际上答案就出现在了问题中：因为他们不是同一个类，你不能保证 <code>DefaultMQProducerImpl</code> 只有 <code>DefaultMQProducer</code> 使用了，所以 <code>DefaultMQProducerImpl</code> 是一定需要验证消息的，至于 <code>DefaultMQProducer</code> 验证不验证就看个人喜好，其实不验证问题也不大</p></blockquote><h2 id="路由查找">路由查找</h2><p>在发送消息之前，首先需要获取主题的路由信息，只有获取到了路由信息我们才能找到消息要发送到哪个<code>Broker</code> 中，具体表现在 <code>TopicPublishInfo info = this.tryToFindTopicPublishInfo(msg.getTopic());</code> 方法中。返回的消息就是具体的路由信息，我们首先介绍一下什么是 <code>TopicPublishInfo</code></p><h3 id="topicpublishinfo"><code>TopicPublishInfo</code></h3><p>它存放了关于一个topic中的全部信息。我们先来看一下它的内部构造，</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TopicPublishInfo</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 是否是有序消息</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> orderTopic <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token comment">// 是否有路由信息</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> haveTopicRouterInfo <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token comment">// message queue 信息</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageQueue</span><span class="token punctuation">></span></span> messageQueueList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageQueue</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 用于选择消息队列，每次选择一次消息队列，该值都会自增</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">ThreadLocalIndex</span> sendWhichQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocalIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 主题元数据</span>
    <span class="token keyword">private</span> <span class="token class-name">TopicRouteData</span> topicRouteData<span class="token punctuation">;</span>
	<span class="token keyword">public</span> <span class="token class-name">MessageQueue</span> <span class="token function">selectOneMessageQueue</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> lastBrokerName<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 选择与上次broker不同的队列，如果发现都是在同一个broker中则随机选择一个队列</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">public</span> <span class="token class-name">MessageQueue</span> <span class="token function">selectOneMessageQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 随机选择一个队列</span>
    <span class="token punctuation">&#125;</span>   
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TopicRouteData</span> <span class="token keyword">extends</span> <span class="token class-name">RemotingSerializable</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">// </span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> orderTopicConf<span class="token punctuation">;</span>
    <span class="token comment">// topic 队列元数据</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">QueueData</span><span class="token punctuation">></span></span> queueDatas<span class="token punctuation">;</span>
    <span class="token comment">// broker 元数据</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BrokerData</span><span class="token punctuation">></span></span> brokerDatas<span class="token punctuation">;</span>
    <span class="token comment">// broker上过滤服务器的地址</span>
    <span class="token keyword">private</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token comment">/* brokerAddr */</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span><span class="token comment">/* Filter Server */</span><span class="token operator">></span> filterServerTable<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre><p>有些小伙伴可能看到代码可能还比较模糊，那么我们再具体一点，这个类可以解决：一个Topic有多少个队列(messageQueueList.size)，每个队列的信息(MessageQueue)，我们可以自由选择队列(selectOneMessageQueue)、也可以<strong>排除掉一个broker来选择队列（均匀分布压力、排除异常broker）</strong>，</p><p><code>TopicPublishInfo</code> 中的 <code>TopicRouteData</code> 数据则表明了这个topic的数据分布情况，比如说topic、queue分布在哪些broker中，queue有多少个读队列多少个写队列等。</p><h3 id="查找算法">查找算法</h3><p>我们主要来介绍 <code>DefaultMQProducer.tryToFindTopicPublishInfo</code> 方法，这个方法实现了查找具体的topic信息</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ConcurrentMap</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token comment">/* topic */</span><span class="token punctuation">,</span> <span class="token class-name">TopicPublishInfo</span><span class="token operator">></span> topicPublishInfoTable <span class="token operator">=</span>
        <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">TopicPublishInfo</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token class-name">MQClientInstance</span> mQClientFactory<span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token class-name">TopicPublishInfo</span> <span class="token function">tryToFindTopicPublishInfo</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> topic<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">TopicPublishInfo</span> topicPublishInfo <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>topicPublishInfoTable<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> topicPublishInfo <span class="token operator">||</span> <span class="token operator">!</span>topicPublishInfo<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>topicPublishInfoTable<span class="token punctuation">.</span><span class="token function">putIfAbsent</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TopicPublishInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>mQClientFactory<span class="token punctuation">.</span><span class="token function">updateTopicRouteInfoFromNameServer</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
        topicPublishInfo <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>topicPublishInfoTable<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>topicPublishInfo<span class="token punctuation">.</span><span class="token function">isHaveTopicRouterInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> topicPublishInfo<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> topicPublishInfo<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>mQClientFactory<span class="token punctuation">.</span><span class="token function">updateTopicRouteInfoFromNameServer</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQProducer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        topicPublishInfo <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>topicPublishInfoTable<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> topicPublishInfo<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre><p>首先从当前生产者内存缓存中查询topic的信息，如果找到了topic信息则直接返回内存缓存中的信息。如果未找到信息则接着从 <code>NameServer</code> 中查找。注意这个 <code>MQClientInstance</code> 也是一个相当熟悉的类了，我们之前说 <code>MQClientInstance</code> 封住了RocketMQ网络处理API，是一个非常重要的类，生产者就是通过它来和 <code>NameServer</code> 请求数据的。而且从这段代码中我们看到生产者分别请求了两次 <code>NameServer</code> ，并且第二次请求多了几个参数，这是因为第一次请求不到topic信息，所以第二次请求默认主题 <code>createTopicKey</code> 的信息，这也就是第二个参数 <code>isDefault:true</code> 的含义，至于为什么需要传递<code>defaultMQProducer</code>是因为需要获取<code>createTopicKey</code>的值。</p><blockquote><p>看到这里可能就有人要问了：为什么<code>updateTopicRouteInfoFromNameServer</code>不需要传递具体的生产者过去，之后我们就可以直接从生产者内部缓存<code>topicPublishInfoTable</code>直接拿取数据呢？</p><p>还记得上篇文章说的生产者注册流程吧， 每一个生产者启动的之后都会把自身注册到 <code>MQClientInstance</code> 中，所以 <code>MQClientInstance</code> 中已经包含了生产者，自然就不需要传递行参了</p></blockquote><h2 id="消息发送">消息发送</h2><p>找到了topic信息我们可以来进行消息发送了，首先我们可以先思考一下消息发送的流程，是不是我们直接消息发送一下就可以了呢？并不是的，我们要考虑到网络异常等偶然的原因导致的消息发送失败，一般来说解决这种问题最简单的方法也就是重试</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">int</span> timesTotal <span class="token operator">=</span> communicationMode <span class="token operator">==</span> <span class="token class-name">CommunicationMode</span><span class="token punctuation">.</span>SYNC <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQProducer<span class="token punctuation">.</span><span class="token function">getRetryTimesWhenSendFailed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> times <span class="token operator">&lt;</span> timesTotal<span class="token punctuation">;</span> times<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">// 选择消息队列</span>
    <span class="token comment">// 发送消息   </span>
<span class="token punctuation">&#125;</span></code></pre><p>这里是同步方法的重试次数计算公式，异步重试机制在收到消息发送结构之后执行回执回调之前进行重试。接下来其实也很简单，就是选择消息队列、发送消息、发送消息成功就返回，失败就重试。</p><h3 id="选择消息队列">选择消息队列</h3><pre class="language-java" data-language="java"><code class="language-java"><span class="token comment">// sendDefaultImpl 方法内部，上一段代码的for循环之中</span>
<span class="token class-name">String</span> lastBrokerName <span class="token operator">=</span> <span class="token keyword">null</span> <span class="token operator">==</span> mq <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> mq<span class="token punctuation">.</span><span class="token function">getBrokerName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">MessageQueue</span> mqSelected <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">selectOneMessageQueue</span><span class="token punctuation">(</span>topicPublishInfo<span class="token punctuation">,</span> lastBrokerName<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token class-name">MessageQueue</span> <span class="token function">selectOneMessageQueue</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">TopicPublishInfo</span> tpInfo<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> lastBrokerName<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mqFaultStrategy<span class="token punctuation">.</span><span class="token function">selectOneMessageQueue</span><span class="token punctuation">(</span>tpInfo<span class="token punctuation">,</span> lastBrokerName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// MQFaultStrategy.java</span>
<span class="token keyword">public</span> <span class="token class-name">MessageQueue</span> <span class="token function">selectOneMessageQueue</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">TopicPublishInfo</span> tpInfo<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> lastBrokerName<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sendLatencyFaultEnable<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// do something</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> tpInfo<span class="token punctuation">.</span><span class="token function">selectOneMessageQueue</span><span class="token punctuation">(</span>lastBrokerName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre><p>可以看出消息队列的选择主要由 <code>MQFaultStrategy</code> 实现，我们直接看上段代码的第11行， 是否开启Broker的故障延迟机制。</p><p>如果不开启broker的发送延时故障机制的话，默认就是消息队列轮询投递，如果某一个broker发送一场就排除掉这个broker，这是一个比较简单的算法，也基本能够使得队列消息数分布均匀，但是这也暴露了一个问题，就是有一些队列可能因为自身数量积压等原因，可能投递的时间比较长，对于这样的队列会影响后续投递的效果。</p><p>那么如何解决这个问题呢，我们可以统计出每次消息发送的投递时长，根据这个时长不就可以知道哪个队列投递较快了吗？这也就是 <code>sendLatencyFaultEnable</code> 的作用。</p><p>首先我们按顺序选择一个投递时间较短的、基本可用的队列，如果找到了就直接返回</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">int</span> index <span class="token operator">=</span> tpInfo<span class="token punctuation">.</span><span class="token function">getSendWhichQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> tpInfo<span class="token punctuation">.</span><span class="token function">getMessageQueueList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> pos <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span>index<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token operator">%</span> tpInfo<span class="token punctuation">.</span><span class="token function">getMessageQueueList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pos <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        pos <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token class-name">MessageQueue</span> mq <span class="token operator">=</span> tpInfo<span class="token punctuation">.</span><span class="token function">getMessageQueueList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>pos<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>latencyFaultTolerance<span class="token punctuation">.</span><span class="token function">isAvailable</span><span class="token punctuation">(</span>mq<span class="token punctuation">.</span><span class="token function">getBrokerName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> mq<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre><p>如果找不到的话就选择一个延时较低的队列，</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">final</span> <span class="token class-name">String</span> notBestBroker <span class="token operator">=</span> latencyFaultTolerance<span class="token punctuation">.</span><span class="token function">pickOneAtLeast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h3 id="具体的消息发送">具体的消息发送</h3><p>调用 <code>sendKernelImpl</code> 的重载方法</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token class-name">SendResult</span> <span class="token function">sendKernelImpl</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Message</span> msg<span class="token punctuation">,</span> <span class="token comment">// 待发送消息</span>
        <span class="token keyword">final</span> <span class="token class-name">MessageQueue</span> mq<span class="token punctuation">,</span> <span class="token comment">// 要发送的mq</span>
        <span class="token keyword">final</span> <span class="token class-name">CommunicationMode</span> communicationMode<span class="token punctuation">,</span> <span class="token comment">// 消息发送模式</span>
        <span class="token keyword">final</span> <span class="token class-name">SendCallback</span> sendCallback<span class="token punctuation">,</span> <span class="token comment">// 异步消息回调函数</span>
        <span class="token keyword">final</span> <span class="token class-name">TopicPublishInfo</span> topicPublishInfo<span class="token punctuation">,</span> <span class="token comment">// topic路由信息</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> timeout <span class="token comment">/*消息发送超时时间*/</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token comment">// 消息发送</span>
<span class="token punctuation">&#125;</span></code></pre><p>开坑，有时间再写</p><blockquote><p>2021.7.1 17.40</p></blockquote><p>接坑，继续写。。。。</p><h4 id="找到broker地址">找到Broker地址</h4><p>首先我们必须要找到要发送到哪个Broker，</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">String</span> brokerAddr <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mQClientFactory<span class="token punctuation">.</span><span class="token function">findBrokerAddressInPublish</span><span class="token punctuation">(</span>mq<span class="token punctuation">.</span><span class="token function">getBrokerName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> brokerAddr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">tryToFindTopicPublishInfo</span><span class="token punctuation">(</span>mq<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    brokerAddr <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mQClientFactory<span class="token punctuation">.</span><span class="token function">findBrokerAddressInPublish</span><span class="token punctuation">(</span>mq<span class="token punctuation">.</span><span class="token function">getBrokerName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// MQClientInstance.java</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ConcurrentMap</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token comment">/* Broker Name */</span><span class="token punctuation">,</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token class-name">Long</span><span class="token comment">/* brokerId */</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token comment">/* address */</span><span class="token operator">>></span> brokerAddrTable <span class="token operator">=</span>
        <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">HashMap</span><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">findBrokerAddressInPublish</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> brokerName<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token class-name">Long</span><span class="token comment">/* brokerId */</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token comment">/* address */</span><span class="token operator">></span> map <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerAddrTable<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>brokerName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>map <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>map<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">MixAll</span><span class="token punctuation">.</span>MASTER_ID<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre><p>这里我们之前确定的消息队列信息来获取Broker的网络地址，这里为什么不从 <code>TopicPublishInfo</code> 中获取 <code>Broker</code> 的地址呢，这是因为 <code>TopicPublishInfo</code> 存放了Broker的地址，但是并没有存放具体的MQ和Broker的对应关系，所以还是要从 <code>MQClientInstance</code> 中获取，可以看到我们从 <code>MQClientInstance</code> 中是获取Broker中的主服务器的地址。如果发现本地没有缓存 Broker 的信息，就从 <code>NameServer</code> 中拉去一次，并再次获取</p><h4 id="为消息分配message-id">为消息分配Message ID</h4><p>首先我们来看一下Message ID的分配吧</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>msg <span class="token keyword">instanceof</span> <span class="token class-name">MessageBatch</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">MessageClientIDSetter</span><span class="token punctuation">.</span><span class="token function">setUniqID</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> sysFlag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">boolean</span> msgBodyCompressed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">tryToCompressMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    sysFlag <span class="token operator">|=</span> <span class="token class-name">MessageSysFlag</span><span class="token punctuation">.</span>COMPRESSED_FLAG<span class="token punctuation">;</span>
    msgBodyCompressed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">final</span> <span class="token class-name">String</span> tranMsg <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token class-name">MessageConst</span><span class="token punctuation">.</span>PROPERTY_TRANSACTION_PREPARED<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>tranMsg <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token function">parseBoolean</span><span class="token punctuation">(</span>tranMsg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    sysFlag <span class="token operator">|=</span> <span class="token class-name">MessageSysFlag</span><span class="token punctuation">.</span>TRANSACTION_PREPARED_TYPE<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre><p>如果该消息是批量消息的话，就会为这一批消息配置一个全局的Message ID，并且尝试压缩消息体并更改状态，如果是事务Prepared消息也更改状态。注意一下这个算法，很明显是使用sysFlag的位来充当一定的信息。这样的话就不必要使用多个状态，而且接下来只要再重复或运算一次就可以得出标识位的状态。</p><h4 id="钩子方法">钩子方法</h4><p>还记得我们之前提到的 <code>Producer</code> 启动时的 <code>RPCHook</code> 对象吧。只是我们当时传递的 <code>null</code> 进去的。在这里就使用到啦。</p><h4 id="构造消息体">构造消息体</h4><p>在这里构造消息体，需要包含一定的信息。比如说生产者组名、Topic名称、默认Topic名称等等。</p><h4 id="消息发送-1">消息发送</h4><p>这里会根据消息传递方式的不同选择不同的消息传递方式进行网络传输</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">switch</span> <span class="token punctuation">(</span>communicationMode<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">case</span> ASYNC<span class="token operator">:</span>
        <span class="token comment">// do async</span>
    <span class="token keyword">case</span> ONEWAY<span class="token operator">:</span>
    <span class="token keyword">case</span> SYNC<span class="token operator">:</span>
        <span class="token comment">// do sync</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token keyword">assert</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre><p>注意异步是在这里进行重试的，原因是因为没有接受到response，但是调用的入口是在收到服务端响应包的时候进行的。</p><h4 id="钩子方法-1">钩子方法</h4><p>同上</p><h2 id="写在结尾">写在结尾</h2><blockquote><p>2021.6.30 20:16</p></blockquote><p>没想到这玩意这么难写，写了快两个小时了还没写完，而且还有很多地方没有写好，比如说：<code>LatencyFaultTolerance</code> 延时策略啊、默认主题啊等等，感觉写一个TODO会好一点，不然都会忘记</p><p>今天就这样吧，明天补上</p><blockquote><p>2021.7.1 18:34</p></blockquote><p>结束生产者，虽然没写什么orz。。。</p></div><div class="reward-container"><div>请用钱砸死我！！！</div><button onclick='var qr=document.getElementById("qr");qr.style.display="none"===qr.style.display?"block":"none"'>打赏</button><div id="qr" style="display:none"><div style="display:inline-block"><img src="https://img.helloteemo.com.cn/wechatpay.png" alt="芒果zzZ 微信支付"><p>微信支付</p></div><div style="display:inline-block"><img src="https://img.helloteemo.com.cn/alipay.png" alt="芒果zzZ 支付宝"><p>支付宝</p></div></div></div><footer class="post-footer"><div class="post-tags"><a href="/tags/RocketMQ/" rel="tag"># RocketMQ</a></div><div class="post-nav"><div class="post-nav-item"><a href="/2021/06/26/RocketMQ/%E7%94%9F%E4%BA%A7%E8%80%85/RocketMQ%E7%94%9F%E4%BA%A7%E8%80%85%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/" rel="prev" title="RocketMQ 生产者启动流程"><i class="fa fa-chevron-left"></i> RocketMQ 生产者启动流程</a></div><div class="post-nav-item"><a href="/2021/07/01/RocketMQ/%E7%94%9F%E4%BA%A7%E8%80%85/RocketMQ%E7%94%9F%E4%BA%A7%E8%80%85%E5%B0%8F%E7%BB%93/" rel="next" title="RocketMQ 生产者小结">RocketMQ 生产者小结 <i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments" id="gitalk-container"></div><script>window.addEventListener("tabs:register",()=>{let{activeClass:t}=CONFIG.comments;if(CONFIG.comments.storage&&(t=localStorage.getItem("comments_active")||t),t){let e=document.querySelector(`a[href="#comment-${t}"]`);e&&e.click()}}),CONFIG.comments.storage&&window.addEventListener("tabs:click",t=>{if(!t.target.matches(".tabs-comment .tab-content .tab-pane"))return;let e=t.target.classList[1];localStorage.setItem("comments_active",e)})</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#rocketmq-%E7%94%9F%E4%BA%A7%E8%80%85%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81"><span class="nav-number">1.</span> <span class="nav-text">RocketMQ 生产者消息发送</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%AA%8C%E8%AF%81%E6%B6%88%E6%81%AF"><span class="nav-number">1.1.</span> <span class="nav-text">验证消息</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B7%AF%E7%94%B1%E6%9F%A5%E6%89%BE"><span class="nav-number">1.2.</span> <span class="nav-text">路由查找</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#topicpublishinfo"><span class="nav-number">1.2.1.</span> <span class="nav-text">TopicPublishInfo</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E6%89%BE%E7%AE%97%E6%B3%95"><span class="nav-number">1.2.2.</span> <span class="nav-text">查找算法</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81"><span class="nav-number">1.3.</span> <span class="nav-text">消息发送</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%89%E6%8B%A9%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97"><span class="nav-number">1.3.1.</span> <span class="nav-text">选择消息队列</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B7%E4%BD%93%E7%9A%84%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81"><span class="nav-number">1.3.2.</span> <span class="nav-text">具体的消息发送</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%89%BE%E5%88%B0broker%E5%9C%B0%E5%9D%80"><span class="nav-number">1.3.2.1.</span> <span class="nav-text">找到Broker地址</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%BA%E6%B6%88%E6%81%AF%E5%88%86%E9%85%8Dmessage-id"><span class="nav-number">1.3.2.2.</span> <span class="nav-text">为消息分配Message ID</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%92%A9%E5%AD%90%E6%96%B9%E6%B3%95"><span class="nav-number">1.3.2.3.</span> <span class="nav-text">钩子方法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9E%84%E9%80%A0%E6%B6%88%E6%81%AF%E4%BD%93"><span class="nav-number">1.3.2.4.</span> <span class="nav-text">构造消息体</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81-1"><span class="nav-number">1.3.2.5.</span> <span class="nav-text">消息发送</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%92%A9%E5%AD%90%E6%96%B9%E6%B3%95-1"><span class="nav-number">1.3.2.6.</span> <span class="nav-text">钩子方法</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%86%99%E5%9C%A8%E7%BB%93%E5%B0%BE"><span class="nav-number">1.4.</span> <span class="nav-text">写在结尾</span></a></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="芒果zzZ" src="https://img.helloteemo.com.cn/logo.png"><p class="site-author-name" itemprop="name">芒果zzZ</p><div class="site-description" itemprop="description">纵有风花雪月又如何</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">63</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">23</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">22</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/helloteemo" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;helloteemo" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a> </span><span class="links-of-author-item"><a href="mailto:zhukewei1998@gmail.com" title="E-Mail → mailto:zhukewei1998@gmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a></span></div><div class="links-of-blogroll motion-element"><div class="links-of-blogroll-title"><i class="fa fa-fw fa-link"></i> Links</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"><a href="https://www.gkshi.com/" title="https:&#x2F;&#x2F;www.gkshi.com&#x2F;" rel="noopener" target="_blank">gkshi的小站</a></li><li class="links-of-blogroll-item"><a href="https://zhouxuwen.github.io/" title="https:&#x2F;&#x2F;zhouxuwen.github.io&#x2F;" rel="noopener" target="_blank">zxw的小破站</a></li><li class="links-of-blogroll-item"><a href="https://sicuni.github.io/" title="https:&#x2F;&#x2F;sicuni.github.io&#x2F;" rel="noopener" target="_blank">sicuni的站点</a></li></ul></div></div><div class="back-to-top motion-element"><i class="fa fa-arrow-up"></i> <span>0%</span></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="beian"><a href="http://www.beian.miit.gov.cn/" rel="noopener" target="_blank">赣ICP备20008539号</a></div><div class="copyright">&copy; 2020 – <span itemprop="copyrightYear">2025</span> <span class="with-love"><i class="fa fa-user"></i> </span><span class="author" itemprop="copyrightHolder">芒果zzZ</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-area-chart"></i> </span><span title="站点总字数">138k</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-coffee"></i> </span><span title="站点阅读时长">2:05</span></div><br><span id="timeDate">载入天数...</span> <span id="times">载入时分秒...</span><script>var now=new Date;function createtime(){var n=new Date("09/21/2020 15:54:40");now.setTime(now.getTime()+250),days=(now-n)/1e3/60/60/24,dnum=Math.floor(days),hours=(now-n)/1e3/60/60-24*dnum,hnum=Math.floor(hours),1==String(hnum).length&&(hnum="0"+hnum),minutes=(now-n)/1e3/60-1440*dnum-60*hnum,mnum=Math.floor(minutes),1==String(mnum).length&&(mnum="0"+mnum),seconds=(now-n)/1e3-86400*dnum-3600*hnum-60*mnum,snum=Math.round(seconds),1==String(snum).length&&(snum="0"+snum),document.getElementById("timeDate").innerHTML="本站已安全运行 "+dnum+" 天 ",document.getElementById("times").innerHTML=hnum+" 小时 "+mnum+" 分 "+snum+" 秒"}setInterval("createtime()",250)</script><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="post-meta-item" id="busuanzi_container_site_uv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-user"></i> </span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span> </span></span><span class="post-meta-divider">|</span> <span class="post-meta-item" id="busuanzi_container_site_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div></div></footer></div><script src="/lib/anime.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script src="/js/local-search.js"></script><script>document.querySelectorAll("pre.mermaid").length&&NexT.utils.getScript("//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js",()=>{mermaid.initialize({theme:"forest",logLevel:3,flowchart:{curve:"linear"},gantt:{axisFormat:"%m/%d/%Y"},sequence:{actorMargin:50}})},window.mermaid)</script><script src="//cdn.jsdelivr.net/npm/quicklink@1/dist/quicklink.umd.js"></script><script>window.addEventListener("load",()=>{quicklink({timeout:3e3,priority:!0,ignores:[e=>e.includes("#"),e=>"https://helloteemo.github.io/2021/06/29/RocketMQ/%E7%94%9F%E4%BA%A7%E8%80%85/RocketMQ%E7%94%9F%E4%BA%A7%E8%80%85%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81/"===e]})})</script><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css"><script>NexT.utils.loadComments(document.querySelector("#gitalk-container"),()=>{NexT.utils.getScript("//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js",()=>{new Gitalk({clientID:"b0b6e2613d61bb99e835",clientSecret:"50a2d0e2f5dbf4ead8968013003a0557d0076283",repo:"helloteemo.github.io",owner:"helloteemo",admin:["helloteemo"],id:"30b24e5e98d92d6ae6b9e9182aa24d8a",language:"zh-CN",distractionFreeMode:!0}).render("gitalk-container")},window.Gitalk)})</script></body></html>